<!DOCTYPE html>
{% load static %}
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=djtsnlvpvb"></script>
    <style type="text/css">
        div#viewLoading {
        text-align: center;
        padding-top: 70px;
        background: #FFFFF0;
        filter: alpha(opacity=60);
        opacity: alpha*0.6;
        }

    </style>




</head>
<body>

<div id="viewLoading">
    <img src="{%static 'viewLoading.gif' %}">
</div>






<div class = 'search'>
    <div class = 'search-body'>
        <select id = 'searchType'>
            <option value = 'statnm'>충전소 이름</option>
            <option value = 'addr'>주소</option>
        </select>
        <input type = 'text' id = "searchKeyword">
        <button id="searchBtn">검색</button>
    </div>
</div>
<div id="map" style="width:100%;height:800px;"></div>

<script  src="http://code.jquery.com/jquery-latest.min.js"></script>
<script>



$(document).ready(function(){
    $('#viewLoading').hide();

    $(window)
		.ajaxStart(function(){
			$('#viewLoading').show();
		})
		.ajaxStop(function(){
		    alert('검색이 완료되었습니다.');
			$('#viewLoading').hide();
		});


    $('#searchBtn').click(function(){
        type = $('#searchType').val()
        keyword = $('#searchKeyword').val()
        $.ajax({
            url : "{% url 'stationSearch' %}",
            type : "post",
            data : {"csrfmiddlewaretoken" : '{{csrf_token}}',
                    type : type,
                    keyword : keyword},
            dataType : 'json',
            success : function(data){

                var markers = [],
                    infoWindows = [];

                for(var i in data){
                    var marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(data[i].lat, data[i].lng),
                        map: map
                        });





                    var contentString = [
                        '<div class="iw_inner">',
                        '    <h3>'+data[i].statnm+'</h3>',
                        '    <p><a href="{% url 'stationDetail' %}">자세히보기</a></p>',
                        '    <h4>'+data[i].addr+'</h4>',
                        '    <p>'+data[i].useTime+'  / '+data[i].busicall+'<br/>',
                        '    '+data[i].info+'<br/> ',
                        '    </p>',
                        '</div>'
                        ].join('');

                    var infoWindow = new naver.maps.InfoWindow({
                        content: contentString,
                        backgroundColor : "#eee",
                        borderColor : "#151515",
                        borderWidth: 4,
                        anchorColor: "#eee",


                        });

                    markers.push(marker);
                    infoWindows.push(infoWindow);


                };

                naver.maps.Event.addListener(map,'idle',function() {
                    updateMarkers(map,markers);
                });



                function updateMarkers(map,markers) {

                    var marker, position;

                    for (var i = 0; i < markers.length; i++) {
                        marker = markers[i]
                        position = marker.getPosition();

                        showMarker(map,marker);
                    }
                }





                function showMarker(map,marker) {
                    if (marker.setMap()) return;
                    marker.setMap(map);
                }

                function getClickHandler(seq) {
                    return function(e) {
                        var marker = markers[seq],
                            infoWindow = infoWindows[seq];

                        if (infoWindow.getMap()) {
                            infoWindow.close();
                        } else {
                            infoWindow.open(map, marker);
                        }
                    }
                }

                for (var i = 0, ii = markers.length; i<ii; i++) {
                    naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
                }
            }
        });

    })
})


var map = new naver.maps.Map("map", {
        zoom: 10,
        center: new naver.maps.LatLng(37.413294, 127.1460516),
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_LEFT,
            style: naver.maps.ZoomControlStyle.SMALL
        }
    }),
    markers = [];

</script>
</body>
</html>
